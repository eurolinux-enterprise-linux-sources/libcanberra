From 0e4446e16099bca0c9fc09e9f4c9e815dd95841a Mon Sep 17 00:00:00 2001
From: Lennart Poettering <lennart@poettering.net>
Date: Tue, 20 Jan 2015 09:27:44 +0100
Subject: [PATCH] pulse: don' try to reconnect immediately if PA is dying

https://bugs.freedesktop.org/show_bug.cgi?id=35024
---
 src/pulse.c | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/src/pulse.c b/src/pulse.c
index 27148d4..58e2086 100644
--- a/src/pulse.c
+++ b/src/pulse.c
@@ -221,6 +221,9 @@ static int context_connect(ca_context *c, ca_bool_t nofail) {
     ca_return_val_if_fail(p->mainloop, CA_ERROR_STATE);
     ca_return_val_if_fail(!p->context, CA_ERROR_STATE);
 
+    /* If this immediate attempt fails, don't try to reconnect. */
+    p->reconnect = FALSE;
+
     if ((ret = convert_proplist(&l, c->props)) < 0)
         return ret;
 
@@ -304,7 +307,10 @@ static void context_state_cb(pa_context *pc, void *userdata) {
              * reconnect, and pass NOFAIL */
             context_connect(c, TRUE);
         }
-    }
+    } else if (state == PA_CONTEXT_READY)
+        /* OK, the connection suceeded once, if it dies now try to
+         * reconnect */
+        p->reconnect = TRUE;
 
     pa_threaded_mainloop_signal(p->mainloop, FALSE);
 }
@@ -416,10 +422,6 @@ int driver_open(ca_context *c) {
         pa_threaded_mainloop_wait(p->mainloop);
     }
 
-    /* OK, the connection suceeded once, if it dies now try to
-     * reconnect */
-    p->reconnect = TRUE;
-
     pa_threaded_mainloop_unlock(p->mainloop);
 
     return CA_SUCCESS;
-- 
1.9.3

